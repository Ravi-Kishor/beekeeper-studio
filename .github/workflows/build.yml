name: Build beekeeper-studio-bin (from amd64 .deb)

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */23 * * *"

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - name: Install base system
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git curl jq sudo github-cli binutils tar

      - name: Create builder user
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      - name: Fetch latest release and download amd64 deb
        id: version
        run: |
          API=$(curl -s https://api.github.com/repos/beekeeper-studio/beekeeper-studio/releases/latest)

          VERSION=$(echo "$API" | jq -r .tag_name | sed 's/^v//')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          URL=$(echo "$API" | jq -r '
            .assets[]
            | select(.name | test("_amd64\\.deb$"))
            | .browser_download_url
          ' | head -n1)

          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "âŒ amd64 .deb not found."
            exit 1
          fi

          curl -L --fail -o beekeeper.deb "$URL"

      - name: Skip if release exists
        id: check
        run: |
          if gh release view v${{ steps.version.outputs.version }} >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Stop if release exists
        if: steps.check.outputs.exists == 'true'
        run: exit 0

      - name: Prepare PKGBUILD
        run: |
          mkdir -p /home/builder/pkg
          mv beekeeper.deb /home/builder/pkg/
          chown -R builder:builder /home/builder/pkg

          printf '%s\n' \
          "pkgname=beekeeper-studio-bin" \
          "pkgver=${{ steps.version.outputs.version }}" \
          "pkgrel=1" \
          "pkgdesc=\"Modern SQL editor (Debian binary repack)\"" \
          "arch=(x86_64)" \
          "url=\"https://github.com/beekeeper-studio/beekeeper-studio\"" \
          "license=(MIT)" \
          "depends=(gtk3 nss libxss)" \
          "options=(!debug)" \
          "source=(\"beekeeper.deb\")" \
          "sha256sums=('SKIP')" \
          "" \
          "package() {" \
          "  cd \"\$srcdir\"" \
          "  ar x beekeeper.deb" \
          "  tar -xf data.tar.* -C \"\$pkgdir\"" \
          "}" \
          > /home/builder/pkg/PKGBUILD

      - name: Build package
        run: |
          su builder -c "cd /home/builder/pkg && makepkg -s --noconfirm"

      - name: Capture package
        id: pkg
        run: |
          FILE=$(ls /home/builder/pkg/beekeeper-studio-bin-*.pkg.tar.zst | head -n1)
          echo "file=$FILE" >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: beekeeper-studio-bin ${{ steps.version.outputs.version }}
          files: ${{ steps.pkg.outputs.file }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
